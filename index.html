<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <!-- CSP Removed: Third-party extensions were causing conflicts. Static site doesn't need strict CSP. -->
    <title>PhysioAssist - AI Recovery</title>

    <!-- PERFORMANCE OPTIMIZATION v2.69: Preload critical fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preload" as="style"
        href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap">
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap"
        media="print" onload="this.media='all'">
    <noscript>
        <link rel="stylesheet"
            href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap">
    </noscript>

    <link rel="stylesheet" href="styles.css">
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üè•</text></svg>">

    <!-- PERFORMANCE v2.69: Defer heavy AI libraries until needed -->
    <!-- TensorFlow.js & PDF.js loaded async - not needed for initial form render -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/universal-sentence-encoder" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js" defer></script>
</head>

<body>

    <!-- v2.69: LANGUAGE SELECTION POPUP (First interaction before form) -->
    <div class="language-popup-overlay" id="languagePopup">
        <div class="language-popup">
            <div class="language-popup-header">
                <span class="language-icon">üåê</span>
                <h2>Choose Your Language</h2>
                <p>‡§Ö‡§™‡§®‡•Ä ‡§≠‡§æ‡§∑‡§æ ‡§ö‡•Å‡§®‡•á‡§Ç</p>
            </div>
            <div class="language-options">
                <button class="language-btn" onclick="selectLanguage('english')">
                    <span class="lang-flag">üá¨üáß</span>
                    <span class="lang-name">English</span>
                </button>
                <button class="language-btn" onclick="selectLanguage('hindi')">
                    <span class="lang-flag">üáÆüá≥</span>
                    <span class="lang-name">‡§π‡§ø‡§Ç‡§¶‡•Ä</span>
                </button>
                <button class="language-btn" onclick="selectLanguage('hinglish')">
                    <span class="lang-flag">üîÄ</span>
                    <span class="lang-name">Hinglish</span>
                    <span class="lang-desc">Mix of Both</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Dynamic Background -->
    <div class="dynamic-bg">
        <div class="blob blob-1"></div>
        <div class="blob blob-2"></div>
    </div>

    <!-- Main Application -->
    <div class="app-container">

        <!-- Immersive Hero Header -->
        <header class="hero-section">
            <div class="hero-content">
                <div class="logo-badge"><span class="logo-icon">üè•</span></div>
                <h1>PhysioAssist</h1>
                <p>AI-Powered Recovery Intelligence</p>
            </div>
            <div class="wave-shape">
                <svg data-name="Layer 1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1200 120"
                    preserveAspectRatio="none">
                    <path
                        d="M321.39,56.44c58-10.79,114.16-30.13,172-41.86,82.39-16.72,168.19-17.73,250.45-.39C823.78,31,906.67,72,985.66,92.83c70.05,18.48,146.53,26.09,214.34,3V0H0V27.35A600.21,600.21,0,0,0,321.39,56.44Z"
                        class="shape-fill"></path>
                </svg>
                </svg>
            </div>
    </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">

        <!-- WIZARD FORM SECTION -->
        <section id="formSection" class="section active">
            <div class="glass-panel">
                <div class="panel-header">
                    <h2>üìã Patient Profile</h2>
                    <span class="step-indicator" id="stepIndicator">Step 1 of 4</span>
                </div>

                <form id="patientForm" class="compact-form">

                    <!-- STEP 1: PERSONAL IDENTITY -->
                    <div class="form-step active" id="step1">
                        <div class="input-group">
                            <div class="floating-input">
                                <input type="text" id="name" name="name" required placeholder=" " class="input-field">
                                <label for="name">Full Name</label>
                            </div>
                            <div class="floating-input">
                                <input type="tel" id="mobile" name="mobile" required placeholder=" " class="input-field"
                                    pattern="[0-9]{10}" maxlength="10" autocomplete="tel">
                                <label for="mobile">Mobile Number</label>
                            </div>
                            <div class="row-inputs">
                                <div class="floating-input">
                                    <input type="number" id="age" name="age" required placeholder=" "
                                        class="input-field">
                                    <label for="age">Age</label>
                                </div>
                                <div class="floating-input">
                                    <select id="gender" name="gender" required class="input-field">
                                        <option value="" disabled selected hidden></option>
                                        <!-- Placeholder Magic -->
                                        <option value="male">Male</option>
                                        <option value="female">Female</option>
                                        <option value="other">Other</option>
                                    </select>
                                    <label for="gender">Gender</label>
                                </div>
                            </div>
                            <div class="row-inputs">
                                <div class="floating-input">
                                    <input type="number" id="weight" name="weight" required placeholder=" "
                                        class="input-field" min="20" max="200" step="0.1">
                                    <label for="weight">Weight (kg)</label>
                                </div>
                                <div class="floating-input">
                                    <input type="number" id="height" name="height" required placeholder=" "
                                        class="input-field" min="100" max="220">
                                    <label for="height">Height (cm)</label>
                                </div>
                            </div>
                        </div>
                        <button type="button" class="btn btn-primary" onclick="nextStep(2)">Next: Lifestyle
                            ‚ûî</button>
                    </div>

                    <!-- STEP 2: LIFESTYLE -->
                    <div class="form-step hidden" id="step2">
                        <div class="input-group">
                            <div class="floating-input">
                                <input type="text" id="occupation" name="occupation" placeholder=" "
                                    class="input-field">
                                <label for="occupation">Occupation</label>
                            </div>
                            <!-- NEW: Activity Field (v2.7) -->
                            <div class="floating-input">
                                <input type="text" id="activity" name="activity" placeholder=" " class="input-field">
                                <label for="activity">Daily Activity (e.g. Badminton, Yoga, Gardening)</label>
                            </div>
                            <div class="floating-input">
                                <select id="dietPreference" name="dietPreference" required class="input-field">
                                    <option value="" disabled selected hidden></option>
                                    <option value="veg">Vegetarian</option>
                                    <option value="non-veg">Non-Vegetarian</option>
                                    <option value="vegan">Vegan</option>
                                    <option value="keto">Keto</option>
                                </select>
                                <label for="dietPreference">Diet Type</label>
                            </div>
                        </div>
                        <div class="nav-buttons">
                            <button type="button" class="btn btn-secondary" onclick="nextStep(1)">Back</button>
                            <button type="button" class="btn btn-primary" onclick="nextStep(3)">Next: Medical
                                History ‚ûî</button>
                        </div>
                    </div>

                    <!-- STEP 3: MEDICAL HISTORY -->
                    <div class="form-step hidden" id="step3">
                        <div class="clinical-group">
                            <h3>Medical Profile</h3>
                            <div class="checkbox-group">
                                <label class="custom-checkbox">
                                    <input type="checkbox" id="condition_diabetes" name="condition_diabetes"
                                        value="yes">
                                    <span>Diabetes</span>
                                </label>
                                <label class="custom-checkbox">
                                    <input type="checkbox" id="condition_bp" name="condition_bp" value="yes">
                                    <span>High BP</span>
                                </label>
                                <label class="custom-checkbox">
                                    <input type="checkbox" id="condition_heart" name="condition_heart" value="yes">
                                    <span>Heart Issue</span>
                                </label>
                            </div>

                            <div class="floating-input" style="margin-top:1rem;">
                                <select id="recentSurgery" name="recentSurgery" class="input-field">
                                    <option value="" disabled selected hidden></option>
                                    <option value="no">No Recent Surgery</option>
                                    <option value="yes_minor">Yes (Minor / < 3 months)</option>
                                    <option value="yes_major">Yes (Major Operation)</option>
                                </select>
                                <label for="recentSurgery">Recent Operations?</label>
                            </div>

                            <!-- UPLOAD SECTION (v2.20) -->
                            <div style="margin-top: 1.5rem; border-top: 1px dashed #E2E8F0; padding-top: 1rem;">
                                <h4 style="margin: 0 0 0.5rem 0; font-size: 0.9rem; color: #475569;">Have an X-Ray, MRI,
                                    or Report? (Optional)</h4>
                                <input type="file" id="reportUpload"
                                    accept="image/jpeg,image/png,image/webp,application/pdf" style="display: none;">
                                <label for="reportUpload"
                                    style="display: flex; align-items: center; justify-content: center; gap: 0.5rem; background: #F1F5F9; border: 2px dashed #94A3B8; border-radius: 8px; padding: 1rem; cursor: pointer; transition: all 0.2s;">
                                    <span style="font-size: 1.5rem;">üìé</span>
                                    <span id="uploadLabelText"
                                        style="color: #64748B; font-size: 0.9rem; font-weight: 500;">Click to Upload
                                        Image/Report (Max 1MB)</span>
                                </label>
                                <div id="previewContainer" style="margin-top: 0.5rem; display: none;">
                                    <div
                                        style="display: flex; align-items: center; gap: 0.5rem; background: #E0F2FE; color: #0369A1; padding: 0.5rem; border-radius: 6px; font-size: 0.85rem;">
                                        <span>‚úÖ</span>
                                        <span id="fileName">report.jpg</span>
                                        <button type="button" id="removeFileBtn"
                                            style="margin-left: auto; background: none; border: none; cursor: pointer; font-size: 1rem;">‚ùå</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="nav-buttons">
                            <button type="button" class="btn btn-secondary" onclick="nextStep(2)">Back</button>
                            <button type="button" class="btn btn-primary" onclick="nextStep(4)">Next: Symptoms
                                ‚ûî</button>
                        </div>
                    </div>

                    <!-- STEP 4: SYMPTOMS -->
                    <div class="form-step hidden" id="step4">
                        <div class="clinical-group">
                            <h3>üìç Tap Where It Hurts</h3>

                            <!-- v2.69: INTERACTIVE 2D BODY DIAGRAM -->
                            <div class="body-diagram-container" id="bodyDiagramContainer">
                                <!-- FRONT VIEW -->
                                <div class="body-diagram-view">
                                    <h4>Front</h4>
                                    <svg class="body-svg" viewBox="0 0 120 240" id="bodyFront">
                                        <!-- Head -->
                                        <ellipse class="body-region" data-region="head" data-name="Head (Cranial)"
                                            cx="60" cy="22" rx="18" ry="20" />
                                        <!-- Neck -->
                                        <rect class="body-region" data-region="neck" data-name="Neck (Cervical Spine)"
                                            x="52" y="42" width="16" height="16" rx="4" />
                                        <!-- Left Shoulder -->
                                        <ellipse class="body-region" data-region="left-shoulder"
                                            data-name="Left Shoulder (Deltoid)" cx="32" cy="62" rx="14" ry="10" />
                                        <!-- Right Shoulder -->
                                        <ellipse class="body-region" data-region="right-shoulder"
                                            data-name="Right Shoulder (Deltoid)" cx="88" cy="62" rx="14" ry="10" />
                                        <!-- Chest -->
                                        <rect class="body-region" data-region="chest" data-name="Chest (Pectorals)"
                                            x="38" y="58" width="44" height="30" rx="6" />
                                        <!-- Left Arm -->
                                        <rect class="body-region" data-region="left-arm"
                                            data-name="Left Arm (Biceps/Triceps)" x="14" y="68" width="14" height="50"
                                            rx="5" />
                                        <!-- Right Arm -->
                                        <rect class="body-region" data-region="right-arm"
                                            data-name="Right Arm (Biceps/Triceps)" x="92" y="68" width="14" height="50"
                                            rx="5" />
                                        <!-- Left Wrist/Hand -->
                                        <ellipse class="body-region" data-region="left-wrist"
                                            data-name="Left Wrist & Hand" cx="18" cy="130" rx="8" ry="12" />
                                        <!-- Right Wrist/Hand -->
                                        <ellipse class="body-region" data-region="right-wrist"
                                            data-name="Right Wrist & Hand" cx="102" cy="130" rx="8" ry="12" />
                                        <!-- Abdomen -->
                                        <rect class="body-region" data-region="abdomen" data-name="Abdomen (Core)"
                                            x="40" y="90" width="40" height="32" rx="6" />
                                        <!-- Hip/Pelvis -->
                                        <rect class="body-region" data-region="hip" data-name="Hip & Pelvis" x="35"
                                            y="124" width="50" height="20" rx="8" />
                                        <!-- Left Thigh -->
                                        <rect class="body-region" data-region="left-thigh"
                                            data-name="Left Thigh (Quadriceps)" x="36" y="146" width="18" height="40"
                                            rx="6" />
                                        <!-- Right Thigh -->
                                        <rect class="body-region" data-region="right-thigh"
                                            data-name="Right Thigh (Quadriceps)" x="66" y="146" width="18" height="40"
                                            rx="6" />
                                        <!-- Left Knee -->
                                        <ellipse class="body-region" data-region="left-knee"
                                            data-name="Left Knee (Patella)" cx="45" cy="192" rx="10" ry="8" />
                                        <!-- Right Knee -->
                                        <ellipse class="body-region" data-region="right-knee"
                                            data-name="Right Knee (Patella)" cx="75" cy="192" rx="10" ry="8" />
                                        <!-- Left Lower Leg -->
                                        <rect class="body-region" data-region="left-calf"
                                            data-name="Left Calf (Gastrocnemius)" x="38" y="202" width="14" height="28"
                                            rx="5" />
                                        <!-- Right Lower Leg -->
                                        <rect class="body-region" data-region="right-calf"
                                            data-name="Right Calf (Gastrocnemius)" x="68" y="202" width="14" height="28"
                                            rx="5" />
                                        <!-- Left Ankle/Foot -->
                                        <ellipse class="body-region" data-region="left-ankle"
                                            data-name="Left Ankle & Foot" cx="45" cy="235" rx="10" ry="5" />
                                        <!-- Right Ankle/Foot -->
                                        <ellipse class="body-region" data-region="right-ankle"
                                            data-name="Right Ankle & Foot" cx="75" cy="235" rx="10" ry="5" />
                                    </svg>
                                </div>

                                <!-- BACK VIEW -->
                                <div class="body-diagram-view">
                                    <h4>Back</h4>
                                    <svg class="body-svg" viewBox="0 0 120 240" id="bodyBack">
                                        <!-- Head Back -->
                                        <ellipse class="body-region" data-region="head-back"
                                            data-name="Head (Occipital)" cx="60" cy="22" rx="18" ry="20" />
                                        <!-- Upper Back/Neck -->
                                        <rect class="body-region" data-region="cervical" data-name="Upper Neck (C1-C4)"
                                            x="48" y="42" width="24" height="12" rx="4" />
                                        <!-- Trapezius -->
                                        <path class="body-region" data-region="trapezius" data-name="Trapezius Muscle"
                                            d="M32,54 Q60,48 88,54 L82,72 Q60,68 38,72 Z" />
                                        <!-- Upper Back -->
                                        <rect class="body-region" data-region="upper-back"
                                            data-name="Upper Back (Thoracic T1-T6)" x="38" y="72" width="44" height="24"
                                            rx="4" />
                                        <!-- Mid Back -->
                                        <rect class="body-region" data-region="mid-back"
                                            data-name="Mid Back (Thoracic T7-T12)" x="40" y="98" width="40" height="22"
                                            rx="4" />
                                        <!-- Lower Back -->
                                        <rect class="body-region" data-region="lower-back"
                                            data-name="Lower Back (Lumbar L1-L5)" x="42" y="122" width="36" height="22"
                                            rx="4" />
                                        <!-- Left Shoulder Blade -->
                                        <ellipse class="body-region" data-region="left-scapula"
                                            data-name="Left Shoulder Blade (Scapula)" cx="34" cy="82" rx="10" ry="14" />
                                        <!-- Right Shoulder Blade -->
                                        <ellipse class="body-region" data-region="right-scapula"
                                            data-name="Right Shoulder Blade (Scapula)" cx="86" cy="82" rx="10"
                                            ry="14" />
                                        <!-- Sacrum/Tailbone -->
                                        <ellipse class="body-region" data-region="sacrum" data-name="Sacrum & Tailbone"
                                            cx="60" cy="152" rx="16" ry="10" />
                                        <!-- Left Glute -->
                                        <ellipse class="body-region" data-region="left-glute"
                                            data-name="Left Gluteus (Buttock)" cx="46" cy="165" rx="14" ry="12" />
                                        <!-- Right Glute -->
                                        <ellipse class="body-region" data-region="right-glute"
                                            data-name="Right Gluteus (Buttock)" cx="74" cy="165" rx="14" ry="12" />
                                        <!-- Left Hamstring -->
                                        <rect class="body-region" data-region="left-hamstring"
                                            data-name="Left Hamstring" x="36" y="178" width="18" height="35" rx="6" />
                                        <!-- Right Hamstring -->
                                        <rect class="body-region" data-region="right-hamstring"
                                            data-name="Right Hamstring" x="66" y="178" width="18" height="35" rx="6" />
                                        <!-- Left Calf Back -->
                                        <rect class="body-region" data-region="left-calf-back"
                                            data-name="Left Calf (Soleus)" x="38" y="215" width="14" height="20"
                                            rx="5" />
                                        <!-- Right Calf Back -->
                                        <rect class="body-region" data-region="right-calf-back"
                                            data-name="Right Calf (Soleus)" x="68" y="215" width="14" height="20"
                                            rx="5" />
                                    </svg>
                                </div>
                            </div>

                            <!-- Selected Regions Display -->
                            <div id="selectedRegionsDisplay" class="selected-regions-display" style="display: none;">
                                <span style="font-size: 0.8rem; color: #92400E;">Selected pain areas:</span>
                                <div id="selectedRegionTags"></div>
                            </div>

                            <p class="body-diagram-hint">üëÜ Tap multiple areas if pain spreads</p>
                            <span class="skip-diagram-link" onclick="toggleTextInput()">Or type location manually
                                ‚Üì</span>

                            <!-- Hidden field for selected regions -->
                            <input type="hidden" id="selectedBodyRegions" name="selectedBodyRegions" value="">

                            <!-- Fallback Text Input (Initially Hidden) -->
                            <div id="textInputFallback" style="display: none; margin-top: 1rem;">
                                <div class="floating-input">
                                    <select id="problemArea" name="problemArea" class="input-field">
                                        <option value="" disabled selected hidden></option>
                                        <option value="neck">Neck & Cervical</option>
                                        <option value="shoulder">Shoulder</option>
                                        <option value="back">Back (Upper/Lower)</option>
                                        <option value="knee">Knee</option>
                                        <option value="ankle">Ankle & Foot</option>
                                        <option value="wrist">Wrist & Hand</option>
                                    </select>
                                    <label for="problemArea">Affected Area</label>
                                </div>
                            </div>

                            <div class="floating-input">
                                <textarea id="problemStatement" name="problemStatement" required rows="4"
                                    placeholder=" " class="input-field textarea"></textarea>
                                <label for="problemStatement">Describe symptoms...</label>
                            </div>

                            <!-- PAIN SCALE -->
                            <div class="pain-scale-container">
                                <label class="pain-label" for="painLevel">Pain Level: <span id="painValueDisplay"
                                        style="color:var(--accent); font-weight:800;">5</span>/10</label>
                                <input type="range" id="painLevel" name="painLevel" min="1" max="10" value="5"
                                    class="pain-slider"
                                    oninput="document.getElementById('painValueDisplay').innerText = this.value">
                                <div class="pain-markers">
                                    <span>üôÇ Mild</span>
                                    <span>üòê Moderate</span>
                                    <span>üò´ Severe</span>
                                </div>
                            </div>
                        </div>
                        <div class="nav-buttons">
                            <button type="button" class="btn btn-secondary" onclick="nextStep(3)">Back</button>
                            <button type="submit" class="btn btn-primary btn-pulse">Generate Plan ‚ö°</button>
                        </div>
                    </div>

                </form>
            </div>
        </section>

        <!-- Loading Section -->
        <section id="loadingSection" class="section hidden">
            <div class="loading-container glass-panel">
                <div class="pulse-icon">ü©∫</div>
                <h3>Analyzing Symptoms...</h3>
                <p>Consulting AI Knowledge Base</p>
            </div>
        </section>

        <!-- Results Section -->
        <section id="resultsSection" class="section hidden">
            <!-- Injected via JavaScript -->
        </section>

    </main>

    <!-- v2.69: EXERCISE REMINDER MODAL -->
    <div class="reminder-modal-overlay" id="reminderModal">
        <div class="reminder-modal">
            <div class="reminder-modal-header">
                <div class="icon">üìÖ</div>
                <h3>Never Miss Your Recovery Exercises!</h3>
                <p>Your plan recommends exercises <span class="highlight" id="exerciseFrequency">3x daily</span></p>
            </div>
            <div class="reminder-options">
                <button class="reminder-option-btn" onclick="setPhoneAlarm()">
                    <span class="icon">üì±</span>
                    <div class="label">
                        <span class="title">Set Phone Alarm</span>
                        <span class="desc">Recommended times: 8 AM, 2 PM, 8 PM</span>
                    </div>
                </button>
                <button class="reminder-option-btn" onclick="downloadCalendar()">
                    <span class="icon">üìÜ</span>
                    <div class="label">
                        <span class="title">Add to Calendar</span>
                        <span class="desc">Download .ics file for Google/Apple Calendar</span>
                    </div>
                </button>
                <button class="reminder-option-btn" onclick="whatsappReminder()">
                    <span class="icon">üí¨</span>
                    <div class="label">
                        <span class="title">WhatsApp Reminder</span>
                        <span class="desc">Send yourself a reminder message</span>
                    </div>
                </button>
            </div>
            <div class="reminder-skip-btn" onclick="closeReminderModal()">
                No thanks, I'll remember
            </div>
        </div>
    </div>

    <div style="text-align: center; color: #cbd5e1; font-size: 0.8rem; padding: 20px;">
        PhysioAssist AI v2.69 (Body Diagram + Reminders) ‚Ä¢ <span id="statusIndicator">System Ready</span>
    </div>
    </div>

    <!-- Scripts Duplicate Removed -->

    <!-- Wizard Logic Script -->
    <script>
        // Floating Label Logic (Consistent across inputs/selects)
        // Floating Label Logic (Optimized v2.21)
        // Uses CSS :valid/:focus mostly, JS only for load/autofill fix
        function initFloatingLabels() {
            const update = (input) => {
                if (input.value && input.value.trim() !== '') {
                    input.classList.add('has-content');
                } else {
                    input.classList.remove('has-content');
                }
            };

            document.querySelectorAll('.input-field').forEach(input => {
                // Only listen to blur (focus out) to avoid Input Lag
                input.addEventListener('blur', () => update(input));
                input.addEventListener('change', () => update(input));

                // Initial check
                setTimeout(() => update(input), 100);
            });
        }
        document.addEventListener('DOMContentLoaded', initFloatingLabels);

        // ========================================
        // v2.69: PERFORMANCE - Defer Animations
        // ========================================
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                document.body.classList.add('animations-ready');
            }, 300);
        });

        // ========================================
        // v2.69: INTERACTIVE BODY DIAGRAM
        // ========================================
        const selectedRegions = new Set();
        const regionData = {}; // Store region names for AI

        function initBodyDiagram() {
            const regions = document.querySelectorAll('.body-region');
            regions.forEach(region => {
                region.addEventListener('click', (e) => {
                    e.preventDefault();
                    const regionId = region.dataset.region;
                    const regionName = region.dataset.name;

                    if (selectedRegions.has(regionId)) {
                        // Deselect
                        selectedRegions.delete(regionId);
                        delete regionData[regionId];
                        region.classList.remove('selected');
                    } else {
                        // Select
                        selectedRegions.add(regionId);
                        regionData[regionId] = regionName;
                        region.classList.add('selected');
                    }

                    updateSelectedDisplay();
                });
            });
        }

        function updateSelectedDisplay() {
            const display = document.getElementById('selectedRegionsDisplay');
            const tagsContainer = document.getElementById('selectedRegionTags');
            const hiddenInput = document.getElementById('selectedBodyRegions');

            if (selectedRegions.size > 0) {
                display.style.display = 'block';
                tagsContainer.innerHTML = Array.from(selectedRegions).map(id =>
                    `<span class="region-tag">${regionData[id]}</span>`
                ).join('');
                // Store as JSON for form submission
                hiddenInput.value = JSON.stringify(regionData);
            } else {
                display.style.display = 'none';
                hiddenInput.value = '';
            }
        }

        function toggleTextInput() {
            const fallback = document.getElementById('textInputFallback');
            const diagram = document.getElementById('bodyDiagramContainer');
            const hint = document.querySelector('.body-diagram-hint');
            const link = document.querySelector('.skip-diagram-link');

            if (fallback.style.display === 'none') {
                fallback.style.display = 'block';
                link.textContent = 'Use body diagram instead ‚Üë';
            } else {
                fallback.style.display = 'none';
                link.textContent = 'Or type location manually ‚Üì';
            }
        }

        document.addEventListener('DOMContentLoaded', initBodyDiagram);

        // ========================================
        // v2.69: EXERCISE REMINDER SYSTEM
        // ========================================
        let currentPlanData = null; // Stored when plan is generated
        let hasShownReminder = false;

        function showReminderModal(planData) {
            if (hasShownReminder || sessionStorage.getItem('reminderShown')) return;

            currentPlanData = planData;
            const modal = document.getElementById('reminderModal');
            modal.classList.add('active');
            hasShownReminder = true;
            sessionStorage.setItem('reminderShown', 'true');
        }

        function closeReminderModal() {
            const modal = document.getElementById('reminderModal');
            modal.classList.remove('active');
        }

        function setPhoneAlarm() {
            alert('üì± Set alarms on your phone for:\n\n‚Ä¢ 8:00 AM - Morning exercises\n‚Ä¢ 2:00 PM - Afternoon stretches\n‚Ä¢ 8:00 PM - Evening recovery\n\nTip: Name each alarm with your exercise!');
            closeReminderModal();
        }

        function downloadCalendar() {
            const now = new Date();
            const tomorrow = new Date(now);
            tomorrow.setDate(tomorrow.getDate() + 1);

            const formatDate = (date, hours) => {
                date.setHours(hours, 0, 0);
                return date.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
            };

            const exercises = currentPlanData?.exercises?.slice(0, 3)?.map(e => e.name).join(', ') || 'PhysioAssist Exercises';

            const icsContent = `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//PhysioAssist//Recovery//EN
BEGIN:VEVENT
UID:physio-morning-${Date.now()}@physioassist
DTSTAMP:${formatDate(new Date(), 8)}
DTSTART:${formatDate(new Date(tomorrow), 8)}
DTEND:${formatDate(new Date(tomorrow), 8).replace('T080000', 'T081500')}
RRULE:FREQ=DAILY;COUNT=30
SUMMARY:üèãÔ∏è Morning Exercises
DESCRIPTION:${exercises}
END:VEVENT
BEGIN:VEVENT
UID:physio-afternoon-${Date.now()}@physioassist
DTSTAMP:${formatDate(new Date(), 14)}
DTSTART:${formatDate(new Date(tomorrow), 14)}
DTEND:${formatDate(new Date(tomorrow), 14).replace('T140000', 'T141500')}
RRULE:FREQ=DAILY;COUNT=30
SUMMARY:üßò Afternoon Stretches
DESCRIPTION:${exercises}
END:VEVENT
BEGIN:VEVENT
UID:physio-evening-${Date.now()}@physioassist
DTSTAMP:${formatDate(new Date(), 20)}
DTSTART:${formatDate(new Date(tomorrow), 20)}
DTEND:${formatDate(new Date(tomorrow), 20).replace('T200000', 'T201500')}
RRULE:FREQ=DAILY;COUNT=30
SUMMARY:üòå Evening Recovery
DESCRIPTION:${exercises}
END:VEVENT
END:VCALENDAR`;

            const blob = new Blob([icsContent], { type: 'text/calendar' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'physioassist-reminders.ics';
            link.click();

            closeReminderModal();
        }

        function whatsappReminder() {
            const exercises = currentPlanData?.exercises?.slice(0, 3)?.map(e => `‚Ä¢ ${e.name}`).join('\n') || '‚Ä¢ Your exercises';
            const msg = encodeURIComponent(
                `üè• EXERCISE REMINDER\n\n` +
                `Today's Exercises:\n${exercises}\n\n` +
                `‚è∞ Times: 8 AM, 2 PM, 8 PM\n\n` +
                `üí™ Stay consistent for faster recovery!`
            );
            window.open(`https://wa.me/?text=${msg}`, '_blank');
            closeReminderModal();
        }

        // Expose for app.js to call after plan generation
        window.showReminderModal = showReminderModal;
        window.getSelectedBodyRegions = () => regionData;

        // ========================================
        // v2.69: LANGUAGE SELECTION SYSTEM
        // ========================================
        const TRANSLATIONS = {
            english: {
                // Form Headers
                patientProfile: 'üìã Patient Profile',
                stepIndicator: 'Step {n} of 4',
                nextLifestyle: 'Next: Lifestyle ‚ûî',
                nextMedical: 'Next: Medical History ‚ûî',
                nextSymptoms: 'Next: Symptoms ‚ûî',
                back: 'Back',
                generatePlan: 'Generate Plan ‚ö°',
                // Labels
                fullName: 'Full Name',
                mobile: 'Mobile Number',
                age: 'Age',
                gender: 'Gender',
                weight: 'Weight (kg)',
                height: 'Height (cm)',
                occupation: 'Occupation',
                activity: 'Daily Activity (e.g. Badminton, Yoga, Gardening)',
                dietType: 'Diet Type',
                // Medical
                medicalProfile: 'Medical Profile',
                diabetes: 'Diabetes',
                highBP: 'High BP',
                heartIssue: 'Heart Issue',
                recentSurgery: 'Recent Operations?',
                uploadReport: 'Have an X-Ray, MRI, or Report? (Optional)',
                clickUpload: 'Click to Upload Image/Report (Max 1MB)',
                // Symptoms
                tapHurts: 'üìç Tap Where It Hurts',
                tapMultiple: 'üëÜ Tap multiple areas if pain spreads',
                typeManually: 'Or type location manually ‚Üì',
                describeSymptoms: 'Describe symptoms...',
                painLevel: 'Pain Level',
                mild: 'üôÇ Mild',
                moderate: 'üòê Moderate',
                severe: 'üò´ Severe',
                affectedArea: 'Affected Area',
                // Diet Options
                vegetarian: 'Vegetarian',
                nonVeg: 'Non-Vegetarian',
                vegan: 'Vegan',
                keto: 'Keto',
                // Gender Options
                male: 'Male',
                female: 'Female',
                other: 'Other',
                front: 'Front',
                backBody: 'Back'
            },
            hindi: {
                patientProfile: 'üìã ‡§∞‡•ã‡§ó‡•Ä ‡§™‡•ç‡§∞‡•ã‡§´‡§æ‡§á‡§≤',
                stepIndicator: '‡§ö‡§∞‡§£ {n} ‡§Æ‡•á‡§Ç ‡§∏‡•á 4',
                nextLifestyle: '‡§Ö‡§ó‡§≤‡§æ: ‡§ú‡•Ä‡§µ‡§®‡§∂‡•à‡§≤‡•Ä ‚ûî',
                nextMedical: '‡§Ö‡§ó‡§≤‡§æ: ‡§ö‡§ø‡§ï‡§ø‡§§‡•ç‡§∏‡§æ ‡§á‡§§‡§ø‡§π‡§æ‡§∏ ‚ûî',
                nextSymptoms: '‡§Ö‡§ó‡§≤‡§æ: ‡§≤‡§ï‡•ç‡§∑‡§£ ‚ûî',
                back: '‡§µ‡§æ‡§™‡§∏',
                generatePlan: '‡§Ø‡•ã‡§ú‡§®‡§æ ‡§¨‡§®‡§æ‡§è‡§Ç ‚ö°',
                fullName: '‡§™‡•Ç‡§∞‡§æ ‡§®‡§æ‡§Æ',
                mobile: '‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§®‡§Ç‡§¨‡§∞',
                age: '‡§â‡§Æ‡•ç‡§∞',
                gender: '‡§≤‡§ø‡§Ç‡§ó',
                weight: '‡§µ‡§ú‡§® (‡§ï‡§ø‡§≤‡•ã)',
                height: '‡§ä‡§Ç‡§ö‡§æ‡§à (‡§∏‡•á‡§Æ‡•Ä)',
                occupation: '‡§µ‡•ç‡§Ø‡§µ‡§∏‡§æ‡§Ø',
                activity: '‡§¶‡•à‡§®‡§ø‡§ï ‡§ó‡§§‡§ø‡§µ‡§ø‡§ß‡§ø (‡§ú‡•à‡§∏‡•á ‡§¨‡•à‡§°‡§Æ‡§ø‡§Ç‡§ü‡§®, ‡§Ø‡•ã‡§ó)',
                dietType: '‡§Ü‡§π‡§æ‡§∞ ‡§™‡•ç‡§∞‡§ï‡§æ‡§∞',
                medicalProfile: '‡§ö‡§ø‡§ï‡§ø‡§§‡•ç‡§∏‡§æ ‡§™‡•ç‡§∞‡•ã‡§´‡§æ‡§á‡§≤',
                diabetes: '‡§°‡§æ‡§Ø‡§¨‡§ø‡§ü‡•Ä‡§ú',
                highBP: '‡§â‡§ö‡•ç‡§ö ‡§∞‡§ï‡•ç‡§§‡§ö‡§æ‡§™',
                heartIssue: '‡§π‡•É‡§¶‡§Ø ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ',
                recentSurgery: '‡§π‡§æ‡§≤ ‡§ï‡•Ä ‡§∏‡§∞‡•ç‡§ú‡§∞‡•Ä?',
                uploadReport: 'X-Ray, MRI ‡§Ø‡§æ ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§π‡•à? (‡§µ‡•à‡§ï‡§≤‡•ç‡§™‡§ø‡§ï)',
                clickUpload: '‡§Ö‡§™‡§≤‡•ã‡§° ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ï‡•ç‡§≤‡§ø‡§ï ‡§ï‡§∞‡•á‡§Ç (‡§Ö‡§ß‡§ø‡§ï‡§§‡§Æ 1MB)',
                tapHurts: 'üìç ‡§¶‡§∞‡•ç‡§¶ ‡§µ‡§æ‡§≤‡•Ä ‡§ú‡§ó‡§π ‡§™‡§∞ ‡§ü‡•à‡§™ ‡§ï‡§∞‡•á‡§Ç',
                tapMultiple: 'üëÜ ‡§ï‡§à ‡§ú‡§ó‡§π ‡§¶‡§∞‡•ç‡§¶ ‡§π‡•ã ‡§§‡•ã ‡§∏‡§≠‡•Ä ‡§™‡§∞ ‡§ü‡•à‡§™ ‡§ï‡§∞‡•á‡§Ç',
                typeManually: '‡§Ø‡§æ ‡§Æ‡•à‡§®‡•ç‡§Ø‡•Å‡§Ö‡§≤ ‡§ü‡§æ‡§á‡§™ ‡§ï‡§∞‡•á‡§Ç ‚Üì',
                describeSymptoms: '‡§≤‡§ï‡•ç‡§∑‡§£ ‡§¨‡§§‡§æ‡§è‡§Ç...',
                painLevel: '‡§¶‡§∞‡•ç‡§¶ ‡§ï‡§æ ‡§∏‡•ç‡§§‡§∞',
                mild: 'üôÇ ‡§π‡§≤‡•ç‡§ï‡§æ',
                moderate: 'üòê ‡§Æ‡§ß‡•ç‡§Ø‡§Æ',
                severe: 'üò´ ‡§ó‡§Ç‡§≠‡•Ä‡§∞',
                affectedArea: '‡§™‡•ç‡§∞‡§≠‡§æ‡§µ‡§ø‡§§ ‡§ï‡•ç‡§∑‡•á‡§§‡•ç‡§∞',
                vegetarian: '‡§∂‡§æ‡§ï‡§æ‡§π‡§æ‡§∞‡•Ä',
                nonVeg: '‡§Æ‡§æ‡§Ç‡§∏‡§æ‡§π‡§æ‡§∞‡•Ä',
                vegan: '‡§µ‡•Ä‡§ó‡§®',
                keto: '‡§ï‡•Ä‡§ü‡•ã',
                male: '‡§™‡•Å‡§∞‡•Å‡§∑',
                female: '‡§Æ‡§π‡§ø‡§≤‡§æ',
                other: '‡§Ö‡§®‡•ç‡§Ø',
                front: '‡§∏‡§æ‡§Æ‡§®‡•á',
                backBody: '‡§™‡•Ä‡§õ‡•á'
            },
            hinglish: {
                patientProfile: 'üìã Patient Profile',
                stepIndicator: 'Step {n} of 4',
                nextLifestyle: 'Next: Lifestyle ‚ûî',
                nextMedical: 'Next: Medical History ‚ûî',
                nextSymptoms: 'Next: Symptoms ‚ûî',
                back: 'Back',
                generatePlan: 'Plan Banao ‚ö°',
                fullName: 'Poora Naam',
                mobile: 'Mobile Number',
                age: 'Umar',
                gender: 'Gender',
                weight: 'Wazan (kg)',
                height: 'Height (cm)',
                occupation: 'Kaam/Job',
                activity: 'Daily Activity (jaise Badminton, Yoga)',
                dietType: 'Khana Type',
                medicalProfile: 'Medical History',
                diabetes: 'Sugar/Diabetes',
                highBP: 'High BP',
                heartIssue: 'Heart Problem',
                recentSurgery: 'Recent Surgery hui?',
                uploadReport: 'X-Ray, MRI ya Report hai? (Optional)',
                clickUpload: 'Upload karne ke liye click karo (Max 1MB)',
                tapHurts: 'üìç Jahan dard hai wahan tap karo',
                tapMultiple: 'üëÜ Agar kai jagah dard hai toh sab pe tap karo',
                typeManually: 'Ya manually type karo ‚Üì',
                describeSymptoms: 'Symptoms batao...',
                painLevel: 'Dard Level',
                mild: 'üôÇ Halka',
                moderate: 'üòê Medium',
                severe: 'üò´ Bahut Zyada',
                affectedArea: 'Affected Area',
                vegetarian: 'Shakahari',
                nonVeg: 'Non-Veg',
                vegan: 'Vegan',
                keto: 'Keto',
                male: 'Male',
                female: 'Female',
                other: 'Other',
                front: 'Front',
                backBody: 'Back'
            }
        };

        function selectLanguage(lang) {
            localStorage.setItem('physioLanguage', lang);
            document.getElementById('languagePopup').classList.add('hidden');
            applyTranslations(lang);
        }

        function applyTranslations(lang) {
            const t = TRANSLATIONS[lang] || TRANSLATIONS.english;

            // Update form labels using data attributes
            document.querySelectorAll('[data-translate]').forEach(el => {
                const key = el.dataset.translate;
                if (t[key]) el.textContent = t[key];
            });

            // Update select options
            const genderSelect = document.getElementById('gender');
            if (genderSelect) {
                const options = genderSelect.querySelectorAll('option');
                options.forEach(opt => {
                    if (opt.value === 'male') opt.textContent = t.male;
                    if (opt.value === 'female') opt.textContent = t.female;
                    if (opt.value === 'other') opt.textContent = t.other;
                });
            }

            // Update body diagram labels
            const frontLabel = document.querySelector('.body-diagram-view:first-child h4');
            const backLabel = document.querySelector('.body-diagram-view:last-child h4');
            if (frontLabel) frontLabel.textContent = t.front;
            if (backLabel) backLabel.textContent = t.backBody;

            // Update hints
            const hint = document.querySelector('.body-diagram-hint');
            if (hint) hint.textContent = t.tapMultiple;

            const skipLink = document.querySelector('.skip-diagram-link');
            if (skipLink) skipLink.textContent = t.typeManually;
        }

        // Check if language already selected
        document.addEventListener('DOMContentLoaded', () => {
            const savedLang = localStorage.getItem('physioLanguage');
            if (savedLang) {
                document.getElementById('languagePopup').classList.add('hidden');
                applyTranslations(savedLang);
            }
        });

        function nextStep(stepNumber) {
            // Hide all steps
            document.querySelectorAll('.form-step').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.form-step').forEach(el => el.classList.remove('active'));

            // Show target step
            const target = document.getElementById('step' + stepNumber);
            if (target) {
                target.classList.remove('hidden');
                target.classList.add('active');

                // Update indicator
                const lang = localStorage.getItem('physioLanguage') || 'english';
                const t = TRANSLATIONS[lang];
                document.getElementById('stepIndicator').innerText = t.stepIndicator.replace('{n}', stepNumber);

                // PERFORMANCE OPTIMIZATION (v2.10)
                // Initialize Heavy AI Model only AFTER user finishes Step 1 (Typing)
                if (stepNumber === 2 && window.SemanticCore && !window.SemanticCore.isReady) {
                    console.log("‚ö° Triggering Deferred AI Core Init...");
                    window.SemanticCore.init();
                }
            }
        }
    </script>
    <!-- SCRIPTS (Order is Critical) -->
    <script src="config.js?v=final70"></script>
    <script src="openrouter-client.js?v=final70"></script>
    <script src="semantic-core.js?v=final70"></script>
    <script src="ai-engine.js?v=final70"></script>
    <script src="sheets-webhook.js?v=final70"></script>
    <script src="app.js?v=final70"></script>
</body>

</html>